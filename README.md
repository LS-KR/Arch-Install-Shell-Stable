
# Arch-Install-Shell-Stable

如你所見, 這是一組自動安裝Arch Linux的Shell腳本  
如果在使用VMware或VirtualBox並且沒有用什麼奇奇怪怪的東西(例如NVMe硬盤)則大可以直接`bash ./Arch-Install-Stable.sh`進行安裝.  

如果您在嘗試在實體計算機或者在VM中啓用了一些不太常見的設置或者嘗試在某些奇奇怪怪的地方安裝, 請閱讀以下段落. 

## 安裝前的準備

### 檢測網路聯絡

一個常見的檢測網路聯絡的方法便是`ping`. 常用的地址通常是`archlinux.org`或者`8.8.8.8`
``` shell
ping archlinux.org
```
通常的response將如下所示
``` shell
PING archlinux.org(archlinux.org (2a01:4f9:c010:6b1f::1)) 56 data bytes
64 bytes from archlinux.org (2a01:4f9:c010:6b1f::1): icmp_seq=1 ttl=46 time=257 ms
64 bytes from archlinux.org (2a01:4f9:c010:6b1f::1): icmp_seq=2 ttl=46 time=277 ms
64 bytes from archlinux.org (2a01:4f9:c010:6b1f::1): icmp_seq=3 ttl=46 time=259 ms
64 bytes from archlinux.org (2a01:4f9:c010:6b1f::1): icmp_seq=4 ttl=46 time=294 ms
64 bytes from archlinux.org (2a01:4f9:c010:6b1f::1): icmp_seq=5 ttl=46 time=303 ms
64 bytes from archlinux.org (2a01:4f9:c010:6b1f::1): icmp_seq=6 ttl=46 time=285 ms
64 bytes from archlinux.org (2a01:4f9:c010:6b1f::1): icmp_seq=7 ttl=46 time=321 ms
64 bytes from archlinux.org (2a01:4f9:c010:6b1f::1): icmp_seq=8 ttl=46 time=262 ms
64 bytes from archlinux.org (2a01:4f9:c010:6b1f::1): icmp_seq=9 ttl=46 time=340 ms
64 bytes from archlinux.org (2a01:4f9:c010:6b1f::1): icmp_seq=10 ttl=46 time=267 ms
64 bytes from archlinux.org (2a01:4f9:c010:6b1f::1): icmp_seq=11 ttl=46 time=282 ms
64 bytes from archlinux.org (2a01:4f9:c010:6b1f::1): icmp_seq=12 ttl=46 time=257 ms
```
網路聯絡故障的排查請參見[ArchWiki](https://wiki.archlinux.org/title/Network_configuration)  
中文鏈路:[ArchWiki](https://wiki.archlinux.org/title/Installation_guide_(%E6%AD%A3%E9%AB%94%E4%B8%AD%E6%96%87))

### 分割硬碟

倉庫中提供了自動分割硬碟的腳本`fntdsk.sh`.應用句法:
``` shell
bash ./fntdsk.sh <disk>
```
例如:
``` shell
bash ./fntdsk.sh /dev/sda
```
在應用此腳本之前, 建議先通過`fdisk -l`獲知硬碟信息  

### 掛載檔案系統

將根分區掛載到`/mnt`. 例如根分區是`/dev/sda2`:
``` shell
mount /dev/sda2 /mnt
```

### 修改鏡像源

如果您在中國大陸, 那麼以下命令將適合您:
``` shell
bash ./ustc-mirror.sh
bash ./Software-source.sh
```
如果您在其他地區, 則可以使用以下命令安裝`vim`後手動修改`/etc/pacman.d/mirrorlist`
``` shell
pacman -S vim
```
`mirrorlist`的格式通常如下:
``` shell
################################################################################
################# Arch Linux mirrorlist generated by Reflector #################
################################################################################

# With:       reflector @/etc/xdg/reflector/reflector.conf
# When:       2022-07-17 09:59:47 UTC
# From:       https://archlinux.org/mirrors/status/json/
# Retrieved:  2022-07-17 09:55:40 UTC
# Last Check: 2022-07-17 09:51:03 UTC

Server = https://mirror.osbeck.com/archlinux/$repo/os/$arch
Server = https://mirror.pseudoform.org/$repo/os/$arch
Server = https://arch.mirror.constant.com/$repo/os/$arch
Server = https://america.mirror.pkgbuild.com/$repo/os/$arch
Server = https://europe.mirror.pkgbuild.com/$repo/os/$arch
Server = https://archlinux.thaller.ws/$repo/os/$arch
Server = https://mirror.telepoint.bg/archlinux/$repo/os/$arch
Server = https://archlinux.mailtunnel.eu/$repo/os/$arch
Server = https://mirror.cyberbits.eu/archlinux/$repo/os/$arch
Server = https://mirror.chaoticum.net/arch/$repo/os/$arch
Server = https://phinau.de/arch/$repo/os/$arch
Server = https://archmirror.it/repos/$repo/os/$arch
Server = https://mirror.cyberbits.asia/archlinux/$repo/os/$arch
Server = https://mirror.csclub.uwaterloo.ca/archlinux/$repo/os/$arch
Server = https://ftp.halifax.rwth-aachen.de/archlinux/$repo/os/$arch
Server = https://archlinux.uk.mirror.allworldit.com/archlinux/$repo/os/$arch
Server = https://archlinux.za.mirror.allworldit.com/archlinux/$repo/os/$arch
Server = https://mirror.theash.xyz/arch/$repo/os/$arch
Server = https://at.arch.mirror.kescher.at/$repo/os/$arch
Server = https://de.arch.mirror.kescher.at/$repo/os/$arch
```
可以在文件頭插入鏡像源的網路鏈路, 例如`https://mirrors.ustc.edu.cn/archlinux/$repo/os/$arch`  

## 安裝

在確認掛載的分區無誤後, 可以運行以下命令進行安裝:
```
bash ./install0.sh
```
這將在您掛載到`/mnt`中的分區中安裝Arch Linux基本操作系統和基本軟體包  

### 設置引導程式

在前面的操作中, `grub`和`efibootmgr`已經自動安裝  
在設置引導程式之前, 您需要使用以下命令進入chroot環境:
``` shell
arch-chroot /mnt
```

#### **UEFI**

您需要按照以下步驟安裝您的引導程式:  
1. 掛載EFI系統分區:  
    例如您的EFI分區爲`/dev/sda1`, 則您需要:
    ``` shell
    mkdir esp
    mount /dev/sda1 esp
    mkdir esp/EFI
    ```
2. 選擇一個啓動引導程式標識, 此處叫做`GRUB`. 這將在`esp/EFI`中創建一個和標識同名的目錄來存儲EFI二進制文件, 同時這個名字還會在UEFI的啓動菜單中標識GRUB啓動項.  
3. 執行以下命令將GRUB EFI程式`grubx64.efi`安裝到`esp/EFI/GRUB`, 並將模塊安裝到`/boot/grub/x86-64-efi`:
    ``` shell
    grub-install --target=x86_64-efi --efi-directory=esp --bootloader-id=GRUB
    ```
4. 卸載EFI系統分區

#### **BIOS**

您使用以下命令安裝您的引導程式. 此處將您的硬碟看作`/dev/sda`
``` shell
grub-install --target=i386-pc /dev/sda
grub-mkconfig -o /boot/grub/grub.cfg
```

其他相關信息可以參照[ArchWiki](https://wiki.archlinux.org/title/GRUB)

### 重新引導進入系統

如果您認爲您已經完成了安裝, 則可以退出chroot環境後卸載`/mnt`掛載點並重新引導系統  
在重新引導的過程中, 請注意您的安裝介質可能會將您重新引導至Live環境中

## 安裝後的配置

當您使用腳本安裝時, 您的root密碼已自動設爲`root`  
登陸入系統後, 請立即執行以下命令啓用網絡聯絡:
``` shell
systemctl start NetworkManager
systenctl enable NetworkManager
```

### 創建普通賬戶

如果您需要一個普通賬戶, 則您可以通過運行以下命令創建:
``` shell
useradd -m -G wheel admin
```
這將會創建一個名爲`admin`的用戶  
同時, 如果您需要給予此賬戶使用sudo的權限, 則您需要修改`/etc/sudoers`:
``` shell
admin   ALL=(ALL:ALL) ALL
```
或
``` shell
%wheel  ALL=(ALL:ALL) ALL
```

一個`/etc/sudoers`的示例:
``` shell
## sudoers file.
##
## This file MUST be edited with the 'visudo' command as root.
## Failure to use 'visudo' may result in syntax or file permission errors
## that prevent sudo from running.
##
## See the sudoers man page for the details on how to write a sudoers file.
##

##
## Host alias specification
##
## Groups of machines. These may include host names (optionally with wildcards),
## IP addresses, network numbers or netgroups.
# Host_Alias	WEBSERVERS = www1, www2, www3

##
## User alias specification
##
## Groups of users.  These may consist of user names, uids, Unix groups,
## or netgroups.
# User_Alias	ADMINS = millert, dowdy, mikef

##
## Cmnd alias specification
##
## Groups of commands.  Often used to group related commands together.
# Cmnd_Alias	PROCESSES = /usr/bin/nice, /bin/kill, /usr/bin/renice, \
# 			    /usr/bin/pkill, /usr/bin/top
# Cmnd_Alias	REBOOT = /sbin/halt, /sbin/reboot, /sbin/poweroff

##
## Defaults specification
##
## You may wish to keep some of the following environment variables
## when running commands via sudo.
##
## Locale settings
# Defaults env_keep += "LANG LANGUAGE LINGUAS LC_* _XKB_CHARSET"
##
## Run X applications through sudo; HOME is used to find the
## .Xauthority file.  Note that other programs use HOME to find   
## configuration files and this may lead to privilege escalation!
# Defaults env_keep += "HOME"
##
## X11 resource path settings
# Defaults env_keep += "XAPPLRESDIR XFILESEARCHPATH XUSERFILESEARCHPATH"
##
## Desktop path settings
# Defaults env_keep += "QTDIR KDEDIR"
##
## Allow sudo-run commands to inherit the callers' ConsoleKit session
# Defaults env_keep += "XDG_SESSION_COOKIE"
##
## Uncomment to enable special input methods.  Care should be taken as
## this may allow users to subvert the command being run via sudo.
# Defaults env_keep += "XMODIFIERS GTK_IM_MODULE QT_IM_MODULE QT_IM_SWITCHER"
##
## Uncomment to use a hard-coded PATH instead of the user's to find commands
# Defaults secure_path="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
##
## Uncomment to send mail if the user does not enter the correct password.
# Defaults mail_badpass
##
## Uncomment to enable logging of a command's output, except for
## sudoreplay and reboot.  Use sudoreplay to play back logged sessions.
## Sudo will create up to 2,176,782,336 I/O logs before recycling them.
## Set maxseq to a smaller number if you don't have unlimited disk space.
# Defaults log_output
# Defaults!/usr/bin/sudoreplay !log_output
# Defaults!/usr/local/bin/sudoreplay !log_output
# Defaults!REBOOT !log_output
# Defaults maxseq = 1000

##
## Runas alias specification
##

##
## User privilege specification
##
root ALL=(ALL:ALL) ALL

## Uncomment to allow members of group wheel to execute any command
%wheel ALL=(ALL:ALL) ALL

## Same thing without a password
# %wheel ALL=(ALL:ALL) NOPASSWD: ALL

## Uncomment to allow members of group sudo to execute any command
# %sudo	ALL=(ALL:ALL) ALL

## Uncomment to allow any user to run sudo if they know the password
## of the user they are running the command as (root by default).
# Defaults targetpw  # Ask for the password of the target user
# ALL ALL=(ALL:ALL) ALL  # WARNING: only use this together with 'Defaults targetpw'

## Read drop-in files from /etc/sudoers.d
@includedir /etc/sudoers.d
```

### 安裝桌面

倉庫中提供了安裝桌面的引導式腳本`Desktop.sh`
支持安裝`KDE Plasma`, `xfce4`, `Gnome3`, `mate`, `Budgie`桌面:
``` shell
bash ./Desktop.sh
```

請注意: 您在運行此腳本之前必須已經創建了一個普通賬戶

### 軟體源的配置

參見[修改鏡像源]

